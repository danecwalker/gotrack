<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
    integrity="sha512-CQBWl4fJHWbryGE+Pc7UAxWMUMNMWzWxF4SQo9CgkJIN1kx6djDQZjh3Y8SZ1d+6I+1zze6Z7kHXO7q3UyZAWw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
</head>

<body>

  <h1>Store</h1>

  <div hx-get="/api/v1/stats?period=hour" hx-trigger="load" hx-swap="outerHTML">
    <h2>Page Views</h2>
    <h2>Visitors</h2>
    <h2>Bounces</h2>
    <h2>Avg Session Length</h2>
  </div>

  <a href="/">Home</a>
  <canvas id="chart" style="width:100%; height: 600px;"></canvas>
  <script>
    (async function() {
      const res = await fetch('/api/v1/graph?period=30d');
      const d = await res.json();
      const months = {
        '01': 'January',
        '02': 'February',
        '03': 'March',
        '04': 'April',
        '05': 'May',
        '06': 'June',
        '07': 'July',
        '08': 'August',
        '09': 'September',
        '10': 'October',
        '11': 'November',
        '12': 'December',
      }
      
      const data = {
        labels:  d.visitors.map(function({x}) {
            return x;
          }).reverse(),
        datasets: [{
          label: 'Visitors',
          data: d.visitors,
          backgroundColor: [
            '#78bbfa',
          ],
          parsing: {
            xAxisKey: 'x',
            yAxisKey: 'y',
          },
        },
        {
          label: 'Views',
          data: d.page_views,
          backgroundColor: [
            '#cae8ff',
          ],
          borderColor: [
            '#78bbfa',
          ],
          borderWidth: 1,
          parsing: {
            xAxisKey: 'x',
            yAxisKey: 'y',
          },
        }],
      };

      const config = {
        type: 'bar',
        data: data,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
          },
          scales: {
            y: {
              stacked: true,
              beginAtZero: true,
            },
            x: {
              stacked: true,
              ticks: {
                callback: function(value, index, ticks) {
                  return index % 2 === 0 ? new Date(this.getLabelForValue(value)).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                }
              },
              grid: {
                display: false,
              }
            },
          },

        },
      };

      const myChart = new Chart("chart", config);
    })();
  </script>
</body>

</html>